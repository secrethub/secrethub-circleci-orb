description: >
  Install the SecretHub CLI.
parameters:
  version:
    type: string
    default: "0.36.0"
    description: "Version of the SecretHub CLI"
  path:
    type: string
    default: /usr/local/bin
    description: "Path to install SecretHub CLI to"
  shell:
    type: string
    default: /bin/sh
    description: "The shell used to run the install script"

steps:
  - run:
      name: "Install SecretHub CLI"
      shell: << parameters.shell >>
      command: |

        # If the version is not pinned then check if SecretHub is already installed.
        if [ "<< parameters.version >>" = "latest" ] && command -v secrethub >/dev/null 2>&1; then
            exit 0
        fi

        # Get the latest version.
        VERSION="<< parameters.version >>"
        if [ "$VERSION" = "latest" ]; then
            VERSION=$(curl -sSfL "https://api.github.com/repos/secrethub/secrethub-cli/releases/latest" | grep tag_name | awk -F\" '{ print substr($4,2) }')
        fi

        # Get the current platform.
        if uname -a | grep Darwin > /dev/null 2>&1; then
            PLATFORM=darwin
        else
            PLATFORM=linux
        fi

        # If the CLI is not installed or the current version of the CLI does not match the specified one, download the provided version.
        if ! command -v secrethub >/dev/null 2>&1 || [[ $(secrethub --version 2>&1 | cut -d "," -f 1) != *"$VERSION" ]]; then
          mkdir secrethub
          curl -sSfL https://github.com/secrethub/secrethub-cli/releases/download/v$VERSION/secrethub-v$VERSION-$PLATFORM-amd64.tar.gz | tar zxf - -C ./secrethub

          # check if we can install the CLI without sudo
          if ! mv ./secrethub/bin/secrethub << parameters.path >> 2>/dev/null ; then
            sudo mv ./secrethub/bin/secrethub << parameters.path >>
          fi
          rm -rf ./secrethub

          # Add executable to path if it is not there already.
          if ! echo ":$PATH:" | grep -q  ":<<parameters.path>>:"; then
            echo 'export PATH="$PATH:<<parameters.path>>"' >> $BASH_ENV;
          fi
        fi
